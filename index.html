<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lieferdienst Nell - Sehr schnell!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .paid-order {
            background-color: #d1fae5; /* Tailwind green-100 */
            border-left: 4px solid #10b981; /* Tailwind green-500 */
        }
        .unpaid-order {
            background-color: #fee2e2; /* Tailwind red-100 */
            border-left: 4px solid #ef4444; /* Tailwind red-500 */
        }
        /* Custom modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 500px;
            border-radius: 0.5rem;
            text-align: center;
        }
        .modal-buttons button {
            margin: 0 10px;
            padding: 10px 20px;
            border-radius: 0.375rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-sky-500 to-indigo-600 min-h-screen flex flex-col items-center justify-center p-4 text-gray-800">

    <div class="bg-white shadow-2xl rounded-xl p-6 md:p-10 w-full max-w-2xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">Lieferdienst Nell</h1>
            <p class="text-xl text-gray-600 mt-2">Sehr schnell, sehr zuverlässig!</p>
            <p class="text-sm text-gray-500 mt-1">Deine Pausen-Versorgung direkt ins Klassenzimmer.</p>
            <p class="text-md font-semibold text-emerald-600 mt-3">Liefergebühr: Nur 10 Cent!</p>
        </header>

        <div id="auth-status" class="text-center mb-4">
            <p class="text-sm text-gray-500">User ID: <span id="userIdDisplay">Wird geladen...</span></p>
        </div>

        <section id="order-form" class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Neue Bestellung aufgeben:</h2>
            <div class="space-y-4">
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-700">Dein Name:</label>
                    <input type="text" id="customerName" name="customerName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Max Mustermann">
                </div>

                <!-- NEU: Dropdown für beliebte Produkte -->
                <div>
                    <label for="popularItem" class="block text-sm font-medium text-gray-700">Wähle ein Produkt:</label>
                    <select id="popularItem" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <!-- Optionen werden von JavaScript generiert -->
                    </select>
                </div>

                <!-- Bereich für Sonstiges/eigene Eingabe, standardmäßig versteckt -->
                <div id="otherItemInputs" class="space-y-4 hidden">
                    <div>
                        <label for="orderDetails" class="block text-sm font-medium text-gray-700">Deine Bestellung (genauere Details):</label>
                        <textarea id="orderDetails" name="orderDetails" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="z.B. 1x Cola, 2x Mannerschnitten"></textarea>
                    </div>
                    <div>
                        <label for="itemPrice" class="block text-sm font-medium text-gray-700">Preis des Artikels (€):</label>
                        <input type="number" id="itemPrice" name="itemPrice" step="0.01" min="0" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="z.B. 1.50">
                    </div>
                </div>
                
                <button id="submitOrder" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                    Bestellung abschicken
                </button>
            </div>
        </section>

        <hr class="my-8 border-gray-300">

        <section id="orders-list">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700">Aktuelle Bestellungen:</h2>
            <div id="loadingOrders" class="text-center text-gray-500">
                <p>Lade Bestellungen...</p>
            </div>
            <div id="noOrders" class="text-center text-gray-500 hidden">
                <p>Noch keine Bestellungen vorhanden. Sei der Erste!</p>
            </div>
            <div id="ordersContainer" class="space-y-4">
            </div>
        </section>
    </div>

    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage" class="mb-4 text-lg">Möchtest du diese Aktion wirklich durchführen?</p>
            <div class="modal-buttons">
                <button id="confirmAction" class="bg-green-500 hover:bg-green-600 text-white">Ja</button>
                <button id="cancelAction" class="bg-red-500 hover:bg-red-600 text-white">Nein</button>
            </div>
        </div>
    </div>

    <footer class="text-center mt-8 mb-4">
        <p class="text-sm text-indigo-100">&copy; <span id="currentYear"></span> Lieferdienst Nell - Ein Gag-Projekt von Johannes N.</p>
    </footer>

    <script type="module">
        // Firebase Imports (nur einmal und direkt vom CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAKUN198Zp-abFSmXcbTj4DXaTIz-HZQ_s",
            authDomain: "lieferdienst-nell.firebaseapp.com",
            projectId: "lieferdienst-nell",
            storageBucket: "lieferdienst-nell.firebasestorage.app",
            messagingSenderId: "1040028718739",
            appId: "1:1040028718739:web:1d70d11875d75cc195df66",
            measurementId: "G-Y06HR8YKHC"
        };

        // Initialize Firebase
        let app;
        let db;
        let auth;
        let ordersCollection;
        let ordersCollectionPath = `artifacts/${firebaseConfig.appId}/public/data/lieferdienstNellOrders`;
        let currentUserId = null;

        // Konstante für die Liefergebühr
        const DELIVERY_FEE = 0.10; // 10 Cent

        // Array von User IDs für Admin-Funktionen
        // BITTE ERSETZE 'DEINE_JOHANNES_UID_1_HIER' UND 'DEINE_JOHANNES_UID_2_HIER'
        // MIT DEN TATSÄCHLICHEN USER IDs, die Admin-Rechte haben sollen.
        const ADMIN_UIDS = ['7LWBACpvaKdHOxDJDqMmd1kiT5y1', 'oXsY6EHMPmb20t07XGtN7cHLT3z2']; 

        // NEU: Beliebte Produkte mit Preisen
        const POPULAR_ITEMS = [
            { name: "Wähle ein Produkt...", price: 0, isPlaceholder: true },
            { name: "Coca Cola Normal", price: 1.35 },
            { name: "Lemon Spritz", price: 0.45 },
            { name: "Mannerschnitten", price: 0.70 },
            { name: "Mineralwasser Still", price: 0.90 },
            { name: "Sonstiges...", price: 0, isOther: true }
        ];

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');
            console.log("Firebase App initialized successfully.");

            ordersCollection = collection(db, ordersCollectionPath);
            console.log("Orders collection reference created successfully.");

        } catch (error) {
            console.error("Error initializing Firebase:", error);
            const userIdDisplay = document.getElementById('userIdDisplay');
            if(userIdDisplay) userIdDisplay.textContent = "Firebase Fehler";
            throw new Error("Firebase initialization failed. App cannot continue.");
        }


        // --- DOM Elements ---
        const customerNameInput = document.getElementById('customerName');
        const orderDetailsInput = document.getElementById('orderDetails');
        const itemPriceInput = document.getElementById('itemPrice');
        const submitOrderButton = document.getElementById('submitOrder');
        const ordersContainer = document.getElementById('ordersContainer');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loadingOrdersDiv = document.getElementById('loadingOrders');
        const noOrdersDiv = document.getElementById('noOrders');
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // NEU: DOM-Elemente für das Dropdown und den "Sonstiges"-Bereich
        const popularItemSelect = document.getElementById('popularItem');
        const otherItemInputsDiv = document.getElementById('otherItemInputs');

        // Modal elements
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const confirmActionButton = document.getElementById('confirmAction');
        const cancelActionButton = document.getElementById('cancelAction');
        let currentAction = null;

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdDisplay.textContent = currentUserId;
                console.log("User is signed in with UID:", currentUserId);
                loadOrders();
            } else {
                console.log("User is signed out. Attempting to sign in anonymously...");
                userIdDisplay.textContent = "Authentifizierung...";
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInAnonymously(auth);
                    console.log("Anonymous sign in successful.");
                } catch (error) {
                    console.error("Error during anonymous sign-in:", error);
                    userIdDisplay.textContent = "Login fehlgeschlagen";
                }
            }
        });

        // --- Functions ---

        // NEU: Funktion zum Befüllen des Dropdowns
        function populatePopularItemsDropdown() {
            popularItemSelect.innerHTML = ''; // Vorherige Optionen löschen
            POPULAR_ITEMS.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index; // Index als Wert verwenden, um auf das Objekt im Array zuzugreifen
                option.textContent = item.isPlaceholder ? item.name : `${item.name} ${item.price.toFixed(2).replace('.', ',')}€`;
                if (item.isPlaceholder) {
                    option.disabled = true; // Placeholder nicht wählbar machen
                    option.selected = true; // Standardmäßig ausgewählt
                }
                popularItemSelect.appendChild(option);
            });
            // Initialen Zustand setzen
            handlePopularItemSelection();
        }

        // NEU: Funktion zur Handhabung der Dropdown-Auswahl
        function handlePopularItemSelection() {
            const selectedIndex = popularItemSelect.value;
            const selectedItem = POPULAR_ITEMS[selectedIndex];

            if (selectedItem.isOther) {
                otherItemInputsDiv.classList.remove('hidden'); // Felder anzeigen
                orderDetailsInput.value = ''; // Felder leeren
                itemPriceInput.value = '';
            } else {
                otherItemInputsDiv.classList.add('hidden'); // Felder verstecken
                if (selectedItem.isPlaceholder) {
                    orderDetailsInput.value = ''; // Auch leeren, wenn Placeholder gewählt
                    itemPriceInput.value = '';
                } else {
                    orderDetailsInput.value = selectedItem.name; // Feld mit Name füllen
                    itemPriceInput.value = selectedItem.price.toFixed(2); // Feld mit Preis füllen
                }
            }
        }


        // Function to show modal
        function showModal(message, onConfirm) {
            modalMessage.textContent = message;
            currentAction = onConfirm;
            confirmationModal.style.display = "block";
            confirmActionButton.focus();
        }

        // Function to hide modal
        function hideModal() {
            confirmationModal.style.display = "none";
            currentAction = null;
        }

        // Event listeners for modal buttons
        confirmActionButton.addEventListener('click', () => {
            if (currentAction) {
                currentAction();
            }
            hideModal();
        });

        cancelActionButton.addEventListener('click', () => {
            hideModal();
        });

        // Close modal if clicked outside of it
        window.addEventListener('click', (event) => {
            if (event.target == confirmationModal) {
                hideModal();
            }
        });


        // Add new order
        async function addOrder() {
            const name = customerNameInput.value.trim();
            let details = orderDetailsInput.value.trim(); // Jetzt mit let, da es angepasst werden kann
            let itemPrice = parseFloat(itemPriceInput.value); // Jetzt mit let, da es angepasst werden kann

            // NEU: Prüfen, ob ein vordefiniertes Produkt ausgewählt wurde, das kein "Sonstiges" ist
            const selectedIndex = popularItemSelect.value;
            const selectedItem = POPULAR_ITEMS[selectedIndex];

            if (selectedItem && !selectedItem.isPlaceholder && !selectedItem.isOther) {
                // Wenn ein spezifisches Produkt gewählt wurde, verwenden wir dessen Details und Preis
                details = selectedItem.name;
                itemPrice = selectedItem.price;
            } else {
                // Wenn "Sonstiges" oder der Platzhalter ausgewählt wurde,
                // verwenden wir die manuell eingegebenen Werte.
                // Hier müssen wir auch die Validierung anpassen, da die Felder anfangs versteckt sein könnten.
                if (!details) {
                    showModal("Bitte gib die genauen Details für deine 'Sonstiges' Bestellung ein.", () => {});
                    return;
                }
            }

            if (!name) {
                showModal("Bitte gib deinen Namen ein.", () => {});
                return;
            }
            if (isNaN(itemPrice) || itemPrice < 0) {
                showModal("Bitte gib einen gültigen Preis für den Artikel ein (z.B. 1.50).", () => {});
                return;
            }

            if (!ordersCollection) {
                console.error("Orders collection is not initialized.");
                showModal("Fehler: Datenbankverbindung nicht bereit.", () => {});
                return;
            }

            try {
                await addDoc(ordersCollection, {
                    customerName: name,
                    orderDetails: details,
                    itemPrice: itemPrice,
                    isPaid: false,
                    createdAt: serverTimestamp(),
                    orderedByUserId: currentUserId
                });
                customerNameInput.value = '';
                orderDetailsInput.value = '';
                itemPriceInput.value = '';
                popularItemSelect.value = 0; // Dropdown auf Placeholder zurücksetzen
                handlePopularItemSelection(); // Zustand des Formulars anpassen
                console.log("Order added successfully!");
            } catch (error) {
                console.error("Error adding order: ", error);
                showModal("Fehler beim Hinzufügen der Bestellung. Versuche es später erneut.", () => {});
            }
        }

        // Load and display orders
        function loadOrders() {
            if (!auth.currentUser) {
                console.log("User not authenticated yet. Waiting for auth state change.");
                loadingOrdersDiv.classList.remove('hidden');
                noOrdersDiv.classList.add('hidden');
                ordersContainer.innerHTML = '';
                return;
            }
            if (!ordersCollection) {
                console.error("Orders collection is not initialized.");
                loadingOrdersDiv.textContent = "Fehler beim Laden der Bestellungen (DB nicht bereit).";
                return;
            }

            const q = query(ordersCollection, orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                loadingOrdersDiv.classList.add('hidden');
                if (snapshot.empty) {
                    noOrdersDiv.classList.remove('hidden');
                    ordersContainer.innerHTML = '';
                } else {
                    noOrdersDiv.classList.add('hidden');
                    ordersContainer.innerHTML = '';
                    snapshot.docs.forEach(docSnapshot => {
                        const order = docSnapshot.data();
                        const orderId = docSnapshot.id;
                        displayOrder(order, orderId);
                    });
                }
            }, (error) => {
                console.error("Error fetching orders: ", error);
                loadingOrdersDiv.classList.add('hidden');
                ordersContainer.innerHTML = `<p class="text-red-500 text-center">Fehler beim Laden der Bestellungen: ${error.message}</p>`;
            });
        }

        // Display a single order
        function displayOrder(order, orderId) {
            const orderDiv = document.createElement('div');
            orderDiv.className = `p-4 rounded-lg shadow-md border-l-4 ${order.isPaid ? 'paid-order' : 'unpaid-order'}`;

            const nameEl = document.createElement('h3');
            nameEl.className = 'text-lg font-semibold text-gray-800';
            nameEl.textContent = order.customerName;

            const detailsEl = document.createElement('p');
            detailsEl.className = 'text-gray-700 my-1';
            detailsEl.textContent = order.orderDetails;

            const itemPriceEl = document.createElement('p');
            itemPriceEl.className = 'text-sm text-gray-600';
            const formattedItemPrice = (order.itemPrice || 0).toFixed(2).replace('.', ',');
            itemPriceEl.textContent = `Artikelpreis: ${formattedItemPrice} €`;

            const totalPrice = (order.itemPrice || 0) + DELIVERY_FEE;
            const totalPriceEl = document.createElement('p');
            totalPriceEl.className = 'text-md font-bold text-indigo-700 mt-1';
            const formattedTotalPrice = totalPrice.toFixed(2).replace('.', ',');
            totalPriceEl.textContent = `Gesamtpreis: ${formattedTotalPrice} €`;

            const feeEl = document.createElement('p');
            feeEl.className = 'text-sm text-emerald-700 font-medium';
            feeEl.textContent = `(+ ${DELIVERY_FEE.toFixed(2).replace('.', ',')} € Liefergebühr)`;


            const statusEl = document.createElement('p');
            statusEl.className = `text-sm font-medium ${order.isPaid ? 'text-green-600' : 'text-red-600'}`;
            statusEl.textContent = order.isPaid ? 'Bezahlt' : 'Noch nicht bezahlt';

            const timestampEl = document.createElement('p');
            timestampEl.className = 'text-xs text-gray-500 mt-2';
            if (order.createdAt && order.createdAt.toDate) {
                timestampEl.textContent = `Bestellt am: ${order.createdAt.toDate().toLocaleString('de-DE')}`;
            } else {
                timestampEl.textContent = `Bestellzeitpunkt unbekannt`;
            }


            orderDiv.appendChild(nameEl);
            orderDiv.appendChild(detailsEl);
            orderDiv.appendChild(itemPriceEl);
            orderDiv.appendChild(feeEl);
            orderDiv.appendChild(totalPriceEl);
            orderDiv.appendChild(statusEl);
            orderDiv.appendChild(timestampEl);

            // Buttons nur anzeigen, wenn der aktuelle Benutzer ein Admin ist
            if (ADMIN_UIDS.includes(currentUserId)) {
                const togglePaidButton = document.createElement('button');
                togglePaidButton.textContent = order.isPaid ? 'Als unbezahlt markieren' : 'Als bezahlt markieren';
                togglePaidButton.className = `mt-3 py-2 px-3 text-xs font-medium rounded-md transition-colors ${order.isPaid ? 'bg-yellow-400 hover:bg-yellow-500 text-yellow-800' : 'bg-green-500 hover:bg-green-600 text-white'}`;
                togglePaidButton.onclick = () => {
                    showModal(
                        `Möchtest du den Status für ${order.customerName}'s Bestellung wirklich ändern?`,
                        () => togglePaidStatus(orderId, order.isPaid)
                    );
                };

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Löschen';
                deleteButton.className = 'mt-3 ml-2 py-2 px-3 text-xs font-medium rounded-md bg-red-500 hover:bg-red-600 text-white transition-colors';
                deleteButton.onclick = () => {
                    showModal(
                        `Möchtest du die Bestellung von ${order.customerName} wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.`,
                        () => deleteOrder(orderId)
                    );
                };
                orderDiv.appendChild(togglePaidButton);
                orderDiv.appendChild(deleteButton);
            }

            ordersContainer.appendChild(orderDiv);
        }

        // Toggle paid status
        async function togglePaidStatus(orderId, currentStatus) {
            if (!ordersCollection) {
                console.error("Orders collection is not initialized.");
                return;
            }
            const orderRef = doc(db, ordersCollectionPath, orderId);
            try {
                await updateDoc(orderRef, {
                    isPaid: !currentStatus
                });
                console.log("Payment status updated for order:", orderId);
            } catch (error) {
                console.error("Error updating payment status: ", error);
                showModal(`Fehler beim Aktualisieren des Zahlungsstatus: ${error.message}`, () => {});
            }
        }

        // Delete order
        async function deleteOrder(orderId) {
            if (!ordersCollection) {
                console.error("Orders collection is not initialized.");
                return;
            }
            const orderRef = doc(db, ordersCollectionPath, orderId);
            try {
                await deleteDoc(orderRef);
                console.log("Order deleted:", orderId);
            } catch (error) {
                console.error("Error deleting order: ", error);
                showModal(`Fehler beim Löschen der Bestellung: ${error.message}`, () => {});
            }
        }

        // --- Event Listeners ---
        submitOrderButton.addEventListener('click', addOrder);
        // NEU: Event Listener für das Dropdown
        popularItemSelect.addEventListener('change', handlePopularItemSelection);

        // NEU: Initialisierung des Dropdowns beim Laden der Seite
        document.addEventListener('DOMContentLoaded', populatePopularItemsDropdown);
    </script>
</body>
</html>
